# create docker network
docker network create k3snet

# verify that the network is created
docker network ls

# OUTPUT:
sysuser@ubuntudev:~/Downloads$ docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
8e7829d16c21   bridge    bridge    local
2f73a1fcb87d   host      host      local
769e11113b71   k3snet    bridge    local
d5fe4dfa890a   none      null      local

# inspect the network
docker network inspect k3snet

# OUTPUT
sysuser@ubuntudev:~/Downloads$ docker network inspect k3snet
[
    {
        "Name": "k3snet",
        "Id": "769e11113b71bab7f1a32d8b58de8ffd2e6079005a64db8c5e88a410faed7372",
        "Created": "2026-01-28T15:21:49.951504442Z",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv4": true,
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": {},
            "Config": [
                {
                    "Subnet": "172.18.0.0/16",
                    "IPRange": "",
                    "Gateway": "172.18.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Options": {
            "com.docker.network.enable_ipv4": "true",
            "com.docker.network.enable_ipv6": "false"
        },
        "Labels": {},
        "Containers": {},
        "Status": {
            "IPAM": {
                "Subnets": {
                    "172.18.0.0/16": {
                        "IPsInUse": 3,
                        "DynamicIPsAvailable": 65533
                    }
                }
            }
        }
    }
]

# access the directory where the docker files are present

cd /home/sysuser/git/docker/kubernetes-cluster

# build the docker image
docker build -t controlplane-image .

# create a container from this image
docker compose up -d

# ensure that the container is created
docker ps

# OUTPUT
CONTAINER ID   IMAGE                COMMAND            CREATED          STATUS          PORTS     NAMES
27dd501640c5   controlplane-image   "sleep infinity"   17 seconds ago   Up 17 seconds             controlplane

sysuser@ubuntudev:~/git/docker$ kubectl --kubeconfig=/home/sysuser/git/docker/kubernetes-cluster/control-plane/kubeconfig/k3s.yaml proxy

# access the container shell
docker exec -it controlplane bash

########## configuring the worker node #####################

# get the join token. run this in the container

cat /var/lib/rancher/k3s/server/token
K10d4179a2ad4fc257e71213c25f4fd4c71df1188d0b85682bf9b17ce76fedd15a8::server:e8bfa8274072e8308da94dbb29852fba

mkdir -p /tmp/k8s-certs

# Decode CA certificate
grep 'certificate-authority-data:' k3s.yaml | awk '{print $2}' | base64 -d > /tmp/k8s-certs/ca.crt

# Decode client certificate
grep 'client-certificate-data:' k3s.yaml | awk '{print $2}' | base64 -d > /tmp/k8s-certs/client.crt

# Decode client key
grep 'client-key-data:' k3s.yaml | awk '{print $2}' | base64 -d > /tmp/k8s-certs/client.key

/tmp/k8s-certs/ca.crt
/tmp/k8s-certs/client.crt
/tmp/k8s-certs/client.key

# add the following to docker compose to make the ip trusted by curl - --tls-san=192.168.19.131
curl --cacert /tmp/k8s-certs/ca.crt \
     --cert /tmp/k8s-certs/client.crt \
     --key /tmp/k8s-certs/client.key \
     https://192.168.19.131:6443/api/v1/nodes



